name: Build ARM Static Binary

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  GRPC_VERSION: v1.60.0
  CMAKE_VERSION: 3.28.0

jobs:
  build-arm-static:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - arch: armv7
            cross_compile: arm-linux-gnueabihf
            cmake_processor: arm
            march_flags: "-march=armv7-a -mfpu=neon"
          - arch: aarch64
            cross_compile: aarch64-linux-gnu
            cmake_processor: aarch64
            march_flags: "-march=armv8-a"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-${{ matrix.cross_compile }} \
          g++-${{ matrix.cross_compile }} \
          cmake \
          ninja-build \
          git \
          autoconf \
          automake \
          libtool \
          pkg-config \
          wget \
          python3

    - name: Cache gRPC build
      id: cache-grpc
      uses: actions/cache@v3
      with:
        path: |
          ~/grpc-install
          ~/grpc-host-tools
        key: grpc-${{ env.GRPC_VERSION }}-${{ matrix.arch }}-static-v3

    - name: Build gRPC and dependencies
      if: steps.cache-grpc.outputs.cache-hit != 'true'
      run: |
        set -ex
        
        # Set up directories
        mkdir -p ~/grpc-build ~/grpc-install ~/grpc-host-tools
        
        # Clone gRPC
        cd ~/grpc-build
        git clone --recurse-submodules -b ${{ env.GRPC_VERSION }} --depth 1 https://github.com/grpc/grpc
        cd grpc
        
        # ============================================
        # Build host tools (protoc and grpc_cpp_plugin)
        # ============================================
        echo "Building host tools..."
        mkdir -p cmake/build-host
        cd cmake/build-host
        
        cmake ../.. \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DgRPC_BUILD_TESTS=OFF \
          -DgRPC_BUILD_CSHARP_EXT=OFF \
          -DgRPC_BUILD_GRPC_NODE_PLUGIN=OFF \
          -DgRPC_BUILD_GRPC_PHP_PLUGIN=OFF \
          -DgRPC_BUILD_GRPC_PYTHON_PLUGIN=OFF \
          -DgRPC_BUILD_GRPC_RUBY_PLUGIN=OFF
        
        ninja protoc grpc_cpp_plugin
        
        # Save host tools
        cp third_party/protobuf/protoc ~/grpc-host-tools/
        cp grpc_cpp_plugin ~/grpc-host-tools/
        
        # ============================================
        # Build static libraries for ARM
        # ============================================
        echo "Building static libraries for ARM..."
        cd ~/grpc-build/grpc
        mkdir -p cmake/build-arm
        cd cmake/build-arm
        
        # Create toolchain file
        cat > toolchain.cmake << EOF
        set(CMAKE_SYSTEM_NAME Linux)
        set(CMAKE_SYSTEM_PROCESSOR ${{ matrix.cmake_processor }})
        set(CMAKE_C_COMPILER ${{ matrix.cross_compile }}-gcc)
        set(CMAKE_CXX_COMPILER ${{ matrix.cross_compile }}-g++)
        set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
        set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
        set(CMAKE_C_FLAGS "${{ matrix.march_flags }} -fPIC")
        set(CMAKE_CXX_FLAGS "${{ matrix.march_flags }} -fPIC")
        EOF
        
        cmake ../.. \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=toolchain.cmake \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=~/grpc-install \
          -DBUILD_SHARED_LIBS=OFF \
          -DgRPC_INSTALL=ON \
          -DgRPC_BUILD_TESTS=OFF \
          -DgRPC_BUILD_CSHARP_EXT=OFF \
          -DgRPC_BUILD_GRPC_NODE_PLUGIN=OFF \
          -DgRPC_BUILD_GRPC_PHP_PLUGIN=OFF \
          -DgRPC_BUILD_GRPC_PYTHON_PLUGIN=OFF \
          -DgRPC_BUILD_GRPC_RUBY_PLUGIN=OFF \
          -DgRPC_PROTOBUF_PROVIDER=module \
          -DgRPC_ZLIB_PROVIDER=module \
          -DgRPC_CARES_PROVIDER=module \
          -DgRPC_RE2_PROVIDER=module \
          -DgRPC_SSL_PROVIDER=module \
          -DgRPC_ABSL_PROVIDER=module \
          -DOPENSSL_NO_ASM=ON \
          -Dprotobuf_BUILD_SHARED_LIBS=OFF \
          -Dprotobuf_BUILD_TESTS=OFF \
          -Dprotobuf_WITH_ZLIB=OFF
        
        ninja
        ninja install

    - name: Generate protobuf files
      run: |
        export PATH=~/grpc-host-tools:$PATH
        chmod +x ~/grpc-host-tools/protoc
        chmod +x ~/grpc-host-tools/grpc_cpp_plugin
        
        ~/grpc-host-tools/protoc \
          --cpp_out=. \
          --grpc_out=. \
          --plugin=protoc-gen-grpc=~/grpc-host-tools/grpc_cpp_plugin \
          ticket_sync.proto
        
        ls -la *.pb.* *.grpc.*

    - name: Build static binary
      run: |
        # Create a build script for better control
        cat > build_static.sh << 'EOF'
        #!/bin/bash
        set -ex
        
        CROSS_COMPILE=$1
        MARCH_FLAGS=$2
        
        # Compile object files
        ${CROSS_COMPILE}-g++ \
          -std=c++14 \
          ${MARCH_FLAGS} \
          -O2 \
          -fPIC \
          -I~/grpc-install/include \
          -c ticket_client.cpp -o ticket_client.o
        
        ${CROSS_COMPILE}-g++ \
          -std=c++14 \
          ${MARCH_FLAGS} \
          -O2 \
          -fPIC \
          -I~/grpc-install/include \
          -c ticket_sync.pb.cc -o ticket_sync.pb.o
        
        ${CROSS_COMPILE}-g++ \
          -std=c++14 \
          ${MARCH_FLAGS} \
          -O2 \
          -fPIC \
          -I~/grpc-install/include \
          -c ticket_sync.grpc.pb.cc -o ticket_sync.grpc.o
        
        # Link everything statically
        ${CROSS_COMPILE}-g++ \
          -static \
          ${MARCH_FLAGS} \
          -O2 \
          -o ticket_client \
          ticket_client.o \
          ticket_sync.pb.o \
          ticket_sync.grpc.o \
          -L~/grpc-install/lib \
          -L~/grpc-install/lib64 \
          -Wl,--whole-archive \
          -lgrpc++ \
          -lgrpc \
          -Wl,--no-whole-archive \
          -lprotobuf \
          -lgpr \
          -laddress_sorting \
          -lupb_json_lib \
          -lupb_textformat_lib \
          -lupb_collections_lib \
          -lutf8_range_lib \
          -lupb_message_lib \
          -lupb_base_lib \
          -lupb_mem_lib \
          -lre2 \
          -lz \
          -lcares \
          -lssl \
          -lcrypto \
          -labsl_log_internal_check_op \
          -labsl_log_internal_conditions \
          -labsl_log_internal_message \
          -labsl_log_internal_nullguard \
          -labsl_log_internal_proto \
          -labsl_log_internal_format \
          -labsl_log_internal_log_sink_set \
          -labsl_log_internal_globals \
          -labsl_log_internal_fnmatch \
          -labsl_log_sink \
          -labsl_log_entry \
          -labsl_log_initialize \
          -labsl_log_globals \
          -labsl_log_severity \
          -labsl_vlog_config_internal \
          -labsl_log_flags \
          -labsl_flags \
          -labsl_flags_internal \
          -labsl_flags_reflection \
          -labsl_flags_marshalling \
          -labsl_flags_commandlineflag \
          -labsl_flags_commandlineflag_internal \
          -labsl_flags_config \
          -labsl_flags_program_name \
          -labsl_flags_private_handle_accessor \
          -labsl_flags_parse \
          -labsl_flags_usage \
          -labsl_flags_usage_internal \
          -labsl_examine_stack \
          -labsl_failure_signal_handler \
          -labsl_debugging_internal \
          -labsl_demangle_internal \
          -labsl_leak_check \
          -labsl_debugging \
          -labsl_stacktrace \
          -labsl_symbolize \
          -labsl_statusor \
          -labsl_status \
          -labsl_cord \
          -labsl_cordz_info \
          -labsl_cord_internal \
          -labsl_cordz_functions \
          -labsl_exponential_biased \
          -labsl_cordz_handle \
          -labsl_crc_cord_state \
          -labsl_crc32c \
          -labsl_crc_internal \
          -labsl_crc_cpu_detect \
          -labsl_raw_hash_set \
          -labsl_hashtablez_sampler \
          -labsl_hash \
          -labsl_city \
          -labsl_low_level_hash \
          -labsl_random_distributions \
          -labsl_random_seed_sequences \
          -labsl_random_internal_pool_urbg \
          -labsl_random_internal_randen \
          -labsl_random_internal_randen_hwaes \
          -labsl_random_internal_randen_hwaes_impl \
          -labsl_random_internal_randen_slow \
          -labsl_random_internal_platform \
          -labsl_random_internal_seed_material \
          -labsl_random_seed_gen_exception \
          -labsl_bad_optional_access \
          -labsl_bad_variant_access \
          -labsl_synchronization \
          -labsl_graphcycles_internal \
          -labsl_kernel_timeout_internal \
          -labsl_time \
          -labsl_civil_time \
          -labsl_time_zone \
          -labsl_str_format_internal \
          -labsl_strings \
          -labsl_strings_internal \
          -labsl_string_view \
          -labsl_base \
          -labsl_spinlock_wait \
          -labsl_int128 \
          -labsl_throw_delegate \
          -labsl_raw_logging_internal \
          -labsl_malloc_internal \
          -labsl_die_if_null \
          -labsl_strerror \
          -lpthread \
          -lm \
          -ldl \
          -lrt
        EOF
        
        chmod +x build_static.sh
        ./build_static.sh "${{ matrix.cross_compile }}" "${{ matrix.march_flags }}"
        
        # Strip the binary
        ${{ matrix.cross_compile }}-strip ticket_client
        
        # Verify it's statically linked
        file ticket_client
        ${{ matrix.cross_compile }}-readelf -d ticket_client | grep -E "(NEEDED|STATIC)" || true
        
        # Rename with architecture
        mv ticket_client ticket_client-${{ matrix.arch }}

    - name: Test binary info
      run: |
        ls -lh ticket_client-${{ matrix.arch }}
        file ticket_client-${{ matrix.arch }}
        ${{ matrix.cross_compile }}-readelf -h ticket_client-${{ matrix.arch }} | head -20

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: ticket_client-${{ matrix.arch }}
        path: ticket_client-${{ matrix.arch }}

  create-release:
    needs: build-arm-static
    runs-on: ubuntu-22.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      
    - name: Display artifacts
      run: |
        ls -la
        find . -name "ticket_client-*" -exec ls -lh {} \;
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: Release ${{ github.run_number }}
        draft: false
        prerelease: false
        files: |
          ticket_client-armv7/ticket_client-armv7
          ticket_client-aarch64/ticket_client-aarch64
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
