name: Build ARM gRPC Client (Static)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  GRPC_VERSION: v1.60.0
  OUTPUT_BINARY: ticket_client

jobs:
  build-static-arm:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - arch: armv7
            cross_compile: arm-linux-gnueabihf
            cmake_arch: arm
            flags: "-march=armv7-a -mfpu=neon"
          - arch: aarch64
            cross_compile: aarch64-linux-gnu  
            cmake_arch: aarch64
            flags: "-march=armv8-a"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Cache gRPC build
        id: cache-grpc
        uses: actions/cache@v4
        with:
          path: |
            grpc-install-${{ matrix.arch }}
            grpc-host-tools
          key: grpc-${{ env.GRPC_VERSION }}-${{ matrix.arch }}-static-v3
      
      - name: Install build tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            gcc-${{ matrix.cross_compile }} \
            g++-${{ matrix.cross_compile }} \
            build-essential \
            cmake \
            ninja-build \
            git \
            wget \
            python3
      
      - name: Build gRPC and dependencies (if not cached)
        if: steps.cache-grpc.outputs.cache-hit != 'true'
        run: |
          set -ex
          
          echo "=== Building gRPC ${{ env.GRPC_VERSION }} static for ${{ matrix.arch }} ==="
          
          # Clone gRPC with submodules
          git clone --recurse-submodules -b ${{ env.GRPC_VERSION }} --depth 1 \
            https://github.com/grpc/grpc /tmp/grpc
          
          cd /tmp/grpc
          
          # ============================================
          # STEP 1: Build host tools first (protoc and plugin)
          # ============================================
          echo "Building host tools..."
          mkdir -p cmake/build-host
          cd cmake/build-host
          
          cmake ../.. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DgRPC_BUILD_TESTS=OFF \
            -DgRPC_BUILD_CSHARP_EXT=OFF \
            -DgRPC_BUILD_GRPC_NODE_PLUGIN=OFF \
            -DgRPC_BUILD_GRPC_PHP_PLUGIN=OFF \
            -DgRPC_BUILD_GRPC_PYTHON_PLUGIN=OFF \
            -DgRPC_BUILD_GRPC_RUBY_PLUGIN=OFF
          
          # Build only what we need for host
          ninja protoc grpc_cpp_plugin
          
          # Save host tools with absolute paths
          mkdir -p ${{ github.workspace }}/grpc-host-tools
          cp third_party/protobuf/protoc ${{ github.workspace }}/grpc-host-tools/
          cp grpc_cpp_plugin ${{ github.workspace }}/grpc-host-tools/
          chmod +x ${{ github.workspace }}/grpc-host-tools/*

          # ============================================
          # STEP 1.5: Copy standard .proto includes (FIX)
          # ============================================
          echo "Copying standard protobuf includes..."
          mkdir -p ${{ github.workspace }}/grpc-host-tools/include
          # Copy the 'google' directory which contains all standard protos
          cp -r /tmp/grpc/third_party/protobuf/src/google ${{ github.workspace }}/grpc-host-tools/include/
          
          # Get absolute paths for the tools
          PROTOC_PATH=$(realpath ${{ github.workspace }}/grpc-host-tools/protoc)
          GRPC_CPP_PLUGIN_PATH=$(realpath ${{ github.workspace }}/grpc-host-tools/grpc_cpp_plugin)
          
          echo "Host tools built:"
          echo "  protoc: ${PROTOC_PATH}"
          echo "  grpc_cpp_plugin: ${GRPC_CPP_PLUGIN_PATH}"
          ls -la ${{ github.workspace }}/grpc-host-tools/
          
          # ============================================
          # STEP 2: Build static libraries for ARM
          # ============================================
          echo "Building static libraries for ${{ matrix.arch }}..."
          cd /tmp/grpc
          mkdir -p cmake/build-arm
          cd cmake/build-arm
          
          # Create toolchain file for cross-compilation
          cat > toolchain.cmake << 'EOF'
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR ${{ matrix.cmake_arch }})
          set(CMAKE_C_COMPILER ${{ matrix.cross_compile }}-gcc)
          set(CMAKE_CXX_COMPILER ${{ matrix.cross_compile }}-g++)
          set(CMAKE_AR ${{ matrix.cross_compile }}-ar)
          set(CMAKE_RANLIB ${{ matrix.cross_compile }}-ranlib)
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          set(CMAKE_C_FLAGS "${{ matrix.flags }} -fPIC")
          set(CMAKE_CXX_FLAGS "${{ matrix.flags }} -fPIC")
          EOF
          
          # Configure with all dependencies built from source
          # CRITICAL: Set the plugin paths explicitly
          cmake ../.. \
            -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/grpc-install-${{ matrix.arch }} \
            -DBUILD_SHARED_LIBS=OFF \
            -DgRPC_INSTALL=ON \
            -DgRPC_BUILD_TESTS=OFF \
            -DgRPC_BUILD_CSHARP_EXT=OFF \
            -DgRPC_BUILD_GRPC_NODE_PLUGIN=OFF \
            -DgRPC_BUILD_GRPC_PHP_PLUGIN=OFF \
            -DgRPC_BUILD_GRPC_PYTHON_PLUGIN=OFF \
            -DgRPC_BUILD_GRPC_RUBY_PLUGIN=OFF \
            -DgRPC_BUILD_CODEGEN=OFF \
            -DProtobuf_PROTOC_EXECUTABLE=${PROTOC_PATH} \
            -DgRPC_CPP_PLUGIN_EXECUTABLE=${GRPC_CPP_PLUGIN_PATH} \
            -DgRPC_PROTOBUF_PROVIDER=module \
            -DgRPC_ZLIB_PROVIDER=module \
            -DgRPC_CARES_PROVIDER=module \
            -DgRPC_RE2_PROVIDER=module \
            -DgRPC_SSL_PROVIDER=module \
            -DgRPC_ABSL_PROVIDER=module \
            -Dprotobuf_BUILD_SHARED_LIBS=OFF \
            -Dprotobuf_BUILD_TESTS=OFF \
            -DOPENSSL_NO_ASM=ON \
            -DCMAKE_CXX_FLAGS="${{ matrix.flags }} -fPIC" \
            -DCMAKE_C_FLAGS="${{ matrix.flags }} -fPIC"
          
          # Build and install
          ninja
          ninja install
          
          echo "✓ gRPC build complete for ${{ matrix.arch }}"
          ls -lh ${{ github.workspace }}/grpc-install-${{ matrix.arch }}/lib/ | head -20
      
      - name: Generate protobuf code
        run: |
          echo "Generating protobuf/gRPC code..."
          
          # Ensure host tools are executable
          chmod +x ${{ github.workspace }}/grpc-host-tools/*
          
          # Use host tools to generate code
          ${{ github.workspace }}/grpc-host-tools/protoc \
            -I. \ # FIX: Add current directory so 'ticket_sync.proto' can be found
            -I${{ github.workspace }}/grpc-host-tools/include \
            --cpp_out=. \
            --grpc_out=. \
            --plugin=protoc-gen-grpc=${{ github.workspace }}/grpc-host-tools/grpc_cpp_plugin \
            ticket_sync.proto
          
          echo "Generated files:"
          ls -lh *.pb.* *.grpc.pb.*
      
      - name: Build static client binary
        run: |
          echo "Building static binary for ${{ matrix.arch }}..."
          
          # Set paths
          GRPC_INSTALL="${{ github.workspace }}/grpc-install-${{ matrix.arch }}"
          
          # Compile source files to object files first
          ${{ matrix.cross_compile }}-g++ \
            -std=c++14 \
            ${{ matrix.flags }} \
            -O2 \
            -fPIC \
            -I${GRPC_INSTALL}/include \
            -c ticket_client.cpp -o ticket_client.o
          
          ${{ matrix.cross_compile }}-g++ \
            -std=c++14 \
            ${{ matrix.flags }} \
            -O2 \
            -fPIC \
            -I${GRPC_INSTALL}/include \
            -c ticket_sync.pb.cc -o ticket_sync.pb.o
          
          ${{ matrix.cross_compile }}-g++ \
            -std=c++14 \
            ${{ matrix.flags }} \
            -O2 \
            -fPIC \
            -I${GRPC_INSTALL}/include \
            -c ticket_sync.grpc.pb.cc -o ticket_sync.grpc.o
          
          # Get all abseil libraries in correct order
          ABSL_LIBS=$(find ${GRPC_INSTALL}/lib -name "libabsl_*.a" | sort | xargs -n1 basename | sed 's/^lib/-l/' | sed 's/\.a$//' | tr '\n' ' ')
          
          # Link statically with all libraries
          ${{ matrix.cross_compile }}-g++ \
            -static \
            ${{ matrix.flags }} \
            -O2 \
            -o ${{ env.OUTPUT_BINARY }}-${{ matrix.arch }} \
            ticket_client.o \
            ticket_sync.pb.o \
            ticket_sync.grpc.o \
            -L${GRPC_INSTALL}/lib \
            -Wl,--whole-archive \
            -lgrpc++ \
            -lgrpc \
            -Wl,--no-whole-archive \
            -lprotobuf \
            -lgpr \
            -laddress_sorting \
            -lupb_json_lib \
            -lupb_textformat_lib \
            -lupb_collections_lib \
            -lutf8_range_lib \
            -lupb_message_lib \
            -lupb_base_lib \
            -lupb_mem_lib \
            -lre2 \
            -lz \
            -lcares \
            -lssl \
            -lcrypto \
            ${ABSL_LIBS} \
            -lpthread \
            -lm \
            -ldl \
            -lrt \
            -static-libgcc \
            -static-libstdc++
          
          # Strip the binary to reduce size
          ${{ matrix.cross_compile }}-strip ${{ env.OUTPUT_BINARY }}-${{ matrix.arch }}
          
          echo "✓ Build complete!"
          
          # Verify it's truly static
          echo "Binary information:"
          file ${{ env.OUTPUT_BINARY }}-${{ matrix.arch }}
          ls -lh ${{ env.OUTPUT_BINARY }}-${{ matrix.arch }}
          
          echo "Checking for dynamic dependencies (should be none):"
          ${{ matrix.cross_compile }}-readelf -d ${{ env.OUTPUT_BINARY }}-${{ matrix.arch }} | grep NEEDED || echo "✓ No dynamic dependencies - fully static!"
      
      - name: Test binary architecture
        run: |
          echo "ELF Header Information:"
          ${{ matrix.cross_compile }}-readelf -h ${{ env.OUTPUT_BINARY }}-${{ matrix.arch }} | grep -E "Class|Machine|Type|Entry"
      
      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.OUTPUT_BINARY }}-${{ matrix.arch }}
          path: ${{ env.OUTPUT_BINARY }}-${{ matrix.arch }}
          retention-days: 30
  
  create-release:
    needs: build-static-arm
    runs-on: ubuntu-22.04
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts/ -type f -name "ticket_client-*" -exec ls -lh {} \;
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: Release Build #${{ github.run_number }}
          body: |
            ## gRPC Ticket Client - Static ARM Binaries
            
            ### Available Binaries:
            - `ticket_client-armv7` - For ARMv7 devices (32-bit)
            - `ticket_client-aarch64` - For ARM64 devices (64-bit)
            
            ### Usage:
            ```bash
            chmod +x ticket_client-{arch}
            ./ticket_client-{arch} <server:port> <vehicle_id>
            ```
            
            ### Features:
            - Fully static binary (no external dependencies required)
            - Built with gRPC ${{ env.GRPC_VERSION }}
            - Optimized for ARM processors
            
            These binaries will work on any ARM Linux system without requiring any libraries to be installed.
          draft: false
          prerelease: false
          files: |
            artifacts/ticket_client-armv7/ticket_client-armv7
            artifacts/ticket_client-aarch64/ticket_client-aarch64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}