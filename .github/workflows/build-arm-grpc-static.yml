name: Build ARM gRPC Client (Static)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  GRPC_VERSION: v1.60.0
  OUTPUT_BINARY: ocu_service

jobs:
  build-static-arm:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - arch: armv7
            cross_compile: arm-linux-gnueabihf
            cmake_arch: arm
            flags: "-march=armv7-a -mfpu=neon"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Cache gRPC build
        id: cache-grpc
        uses: actions/cache@v4
        with:
          path: |
            grpc-install-${{ matrix.arch }}
            grpc-host-tools
          key: grpc-${{ env.GRPC_VERSION }}-${{ matrix.arch }}-static-v7
      
      - name: Install build tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            gcc-${{ matrix.cross_compile }} \
            g++-${{ matrix.cross_compile }} \
            build-essential \
            cmake \
            ninja-build \
            git \
            wget \
            python3 \
            unzip
      
      - name: Build gRPC and dependencies (if not cached)
        if: steps.cache-grpc.outputs.cache-hit != 'true'
        run: |
          set -ex
          
          echo "=== Building gRPC ${{ env.GRPC_VERSION }} static for ${{ matrix.arch }} ==="
          
          git clone --recurse-submodules -b ${{ env.GRPC_VERSION }} --depth 1 \
            https://github.com/grpc/grpc /tmp/grpc
          
          cd /tmp/grpc
          
          echo "Building host tools..."
          mkdir -p cmake/build-host
          cd cmake/build-host
          
          cmake ../.. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DgRPC_BUILD_TESTS=OFF \
            -DgRPC_BUILD_CSHARP_EXT=OFF \
            -DgRPC_BUILD_GRPC_NODE_PLUGIN=OFF \
            -DgRPC_BUILD_GRPC_PHP_PLUGIN=OFF \
            -DgRPC_BUILD_GRPC_PYTHON_PLUGIN=OFF \
            -DgRPC_BUILD_GRPC_RUBY_PLUGIN=OFF
          
          ninja protoc grpc_cpp_plugin
          
          mkdir -p ${{ github.workspace }}/grpc-host-tools
          cp third_party/protobuf/protoc ${{ github.workspace }}/grpc-host-tools/
          cp grpc_cpp_plugin ${{ github.workspace }}/grpc-host-tools/
          chmod +x ${{ github.workspace }}/grpc-host-tools/*

          echo "Copying standard protobuf includes..."
          mkdir -p ${{ github.workspace }}/grpc-host-tools/include
          cp -r /tmp/grpc/third_party/protobuf/src/google ${{ github.workspace }}/grpc-host-tools/include/
          
          PROTOC_PATH=$(realpath ${{ github.workspace }}/grpc-host-tools/protoc)
          GRPC_CPP_PLUGIN_PATH=$(realpath ${{ github.workspace }}/grpc-host-tools/grpc_cpp_plugin)
          
          echo "Host tools built:"
          echo "  protoc: ${PROTOC_PATH}"
          echo "  grpc_cpp_plugin: ${GRPC_CPP_PLUGIN_PATH}"
          ls -la ${{ github.workspace }}/grpc-host-tools/
          
          echo "Building static libraries for ${{ matrix.arch }}..."
          cd /tmp/grpc
          mkdir -p cmake/build-arm
          cd cmake/build-arm
          
          cat > toolchain.cmake << 'EOF'
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR ${{ matrix.cmake_arch }})
          set(CMAKE_C_COMPILER ${{ matrix.cross_compile }}-gcc)
          set(CMAKE_CXX_COMPILER ${{ matrix.cross_compile }}-g++)
          set(CMAKE_AR ${{ matrix.cross_compile }}-ar)
          set(CMAKE_RANLIB ${{ matrix.cross_compile }}-ranlib)
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          set(CMAKE_C_FLAGS "${{ matrix.flags }} -fPIC")
          set(CMAKE_CXX_FLAGS "${{ matrix.flags }} -fPIC")
          EOF
          
          cmake ../.. \
            -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=toolchain.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/grpc-install-${{ matrix.arch }} \
            -DBUILD_SHARED_LIBS=OFF \
            -DgRPC_INSTALL=ON \
            -DgRPC_BUILD_TESTS=OFF \
            -DgRPC_BUILD_CSHARP_EXT=OFF \
            -DgRPC_BUILD_GRPC_NODE_PLUGIN=OFF \
            -DgRPC_BUILD_GRPC_PHP_PLUGIN=OFF \
            -DgRPC_BUILD_GRPC_PYTHON_PLUGIN=OFF \
            -DgRPC_BUILD_GRPC_RUBY_PLUGIN=OFF \
            -DgRPC_BUILD_CODEGEN=OFF \
            -DProtobuf_PROTOC_EXECUTABLE=${PROTOC_PATH} \
            -DgRPC_CPP_PLUGIN_EXECUTABLE=${GRPC_CPP_PLUGIN_PATH} \
            -DgRPC_PROTOBUF_PROVIDER=module \
            -DgRPC_ZLIB_PROVIDER=module \
            -DgRPC_CARES_PROVIDER=module \
            -DgRPC_RE2_PROVIDER=module \
            -DgRPC_SSL_PROVIDER=module \
            -DgRPC_ABSL_PROVIDER=module \
            -Dprotobuf_BUILD_SHARED_LIBS=OFF \
            -Dprotobuf_BUILD_TESTS=OFF \
            -DOPENSSL_NO_ASM=ON \
            -DCMAKE_CXX_FLAGS="${{ matrix.flags }} -fPIC" \
            -DCMAKE_C_FLAGS="${{ matrix.flags }} -fPIC"
          
          ninja
          ninja install
          
          echo "✓ gRPC build complete for ${{ matrix.arch }}"
          echo "Installed libraries:"
          ls -lh ${{ github.workspace }}/grpc-install-${{ matrix.arch }}/lib/ | head -40
          
          echo ""
          echo "UPB-related libraries:"
          ls -1 ${{ github.workspace }}/grpc-install-${{ matrix.arch }}/lib/ | grep -i upb || echo "No upb libraries found"
          
          echo ""
          echo "UTF8-related libraries:"
          ls -1 ${{ github.workspace }}/grpc-install-${{ matrix.arch }}/lib/ | grep -i utf8 || echo "No utf8 libraries found"
      
      - name: Verify cached gRPC (if cached)
        if: steps.cache-grpc.outputs.cache-hit == 'true'
        run: |
          echo "✓ Using cached gRPC build"
          echo "Cached directories:"
          ls -la grpc-install-${{ matrix.arch }}/ || echo "grpc-install directory not found"
          ls -la grpc-host-tools/ || echo "grpc-host-tools directory not found"
          
          echo "Checking installed libraries:"
          ls -1 grpc-install-${{ matrix.arch }}/lib/*.a 2>/dev/null | wc -l | xargs echo "Number of static libraries:"
          
          echo "Checking host tools:"
          ls -la grpc-host-tools/ 2>/dev/null || echo "No host tools found"

      - name: Generate protobuf code
        run: |
          echo "Generating protobuf/gRPC code..."
          
          # Make sure grpc-host-tools exists and is executable
          if [ -d "grpc-host-tools" ]; then
            chmod +x grpc-host-tools/*
            PROTOC="./grpc-host-tools/protoc"
            GRPC_PLUGIN="./grpc-host-tools/grpc_cpp_plugin"
            INCLUDE_PATH="./grpc-host-tools/include"
          else
            echo "Using system protoc (cached tools not available)"
            PROTOC="protoc"
            GRPC_PLUGIN="grpc_cpp_plugin"
            INCLUDE_PATH="/usr/include"
          fi
          
          $PROTOC \
            -I. \
            -I$INCLUDE_PATH \
            --cpp_out=. \
            --grpc_out=. \
            --plugin=protoc-gen-grpc=$GRPC_PLUGIN \
            ticket_sync.proto
          
          echo "Generated files:"
          ls -lh *.pb.* *.grpc.pb.*
      
      - name: Fix compiler warnings
        run: |
          echo "Fixing compiler warnings..."
          # Fix nodiscard warnings by adding (void) casts
          if [ -f "sender.cpp" ]; then
            sed -i 's/log_purchase(article_id, card_number, quantity, false);/(void)log_purchase(article_id, card_number, quantity, false);/g' sender.cpp
            echo "Fixed nodiscard warnings in sender.cpp"
          else
            echo "sender.cpp not found, skipping warning fix"
          fi
      
      - name: Inspect available libraries
        run: |
          echo "=== All static libraries in grpc-install ==="
          if [ -d "grpc-install-${{ matrix.arch }}" ]; then
            ls -1 grpc-install-${{ matrix.arch }}/lib/*.a | xargs -n1 basename
          else
            echo "grpc-install directory not found!"
          fi
      
      - name: Build static main application binary
        run: |
          echo "Building static binary for ${{ matrix.arch }}..."
          
          # Set GRPC_INSTALL path - use cached one if available
          if [ -d "grpc-install-${{ matrix.arch }}" ]; then
            GRPC_INSTALL="${{ github.workspace }}/grpc-install-${{ matrix.arch }}"
            echo "Using cached gRPC installation at: ${GRPC_INSTALL}"
          else
            echo "ERROR: grpc-install directory not found!"
            exit 1
          fi
          
          C_CXX_FLAGS="-std=c++20 ${{ matrix.flags }} -O2 -fPIC -I${GRPC_INSTALL}/include -Iinclude -Wno-unused-result -Wno-cpp"
          
          # 1. Compile all application source files to object files
          echo "Compiling application sources..."
          ${{ matrix.cross_compile }}-g++ ${C_CXX_FLAGS} -c main.cpp -o main.o
          ${{ matrix.cross_compile }}-g++ ${C_CXX_FLAGS} -c sender.cpp -o sender.o
          ${{ matrix.cross_compile }}-g++ ${C_CXX_FLAGS} -c ticket_manager.cpp -o ticket_manager.o
          ${{ matrix.cross_compile }}-g++ ${C_CXX_FLAGS} -c database.cpp -o database.o
          ${{ matrix.cross_compile }}-g++ ${C_CXX_FLAGS} -c fetcher.cpp -o fetcher.o
          ${{ matrix.cross_compile }}-g++ ${C_CXX_FLAGS} -c coupons.cpp -o coupons.o
          ${{ matrix.cross_compile }}-g++ ${C_CXX_FLAGS} -c articles.cpp -o articles.o
          # Compile SQLite3 from include directory
          ${{ matrix.cross_compile }}-gcc -O2 -fPIC -c include/sqlite3.c -o sqlite3.o

          # Compile generated Protobuf files
          ${{ matrix.cross_compile }}-g++ ${C_CXX_FLAGS} -c ticket_sync.pb.cc -o ticket_sync.pb.o
          ${{ matrix.cross_compile }}-g++ ${C_CXX_FLAGS} -c ticket_sync.grpc.pb.cc -o ticket_sync.grpc.pb.o
          
          # 2. Collect all upb/utf8 libraries
          UPB_LIBS=""
          for lib in upb_json_lib upb_textformat_lib upb_collections_lib upb_message_lib upb_base_lib upb_mem_lib utf8_range_lib utf8_validity utf8_range upb; do
            if [ -f "${GRPC_INSTALL}/lib/lib${lib}.a" ]; then
              UPB_LIBS="${UPB_LIBS} -l${lib}"
            fi
          done
          
          echo "Using UPB libraries: ${UPB_LIBS}"
          
          # Get all absl libraries
          ABSL_LIBS=$(find ${GRPC_INSTALL}/lib -name "libabsl_*.a" | xargs -n1 basename | sed 's/^lib/-l/' | sed 's/\.a$//' | tr '\n' ' ')
          echo "Using ABSL libraries: ${ABSL_LIBS}"
          
          # 3. Link the final binary
          echo "Linking final binary..."
          ${{ matrix.cross_compile }}-g++ \
            -static \
            ${{ matrix.flags }} \
            -O2 \
            -o ${{ env.OUTPUT_BINARY }}-${{ matrix.arch }} \
            main.o \
            sender.o \
            ticket_manager.o \
            database.o \
            fetcher.o \
            coupons.o \
            articles.o \
            sqlite3.o \
            ticket_sync.pb.o \
            ticket_sync.grpc.pb.o \
            -L${GRPC_INSTALL}/lib \
            -Wl,--whole-archive \
            -lgrpc++ \
            -lgrpc \
            ${ABSL_LIBS} \
            -Wl,--no-whole-archive \
            -lprotobuf \
            -lgpr \
            -laddress_sorting \
            ${UPB_LIBS} \
            -lre2 \
            -lz \
            -lcares \
            -lssl \
            -lcrypto \
            -lpthread \
            -lm \
            -ldl \
            -lrt \
            -static-libgcc \
            -static-libstdc++
          
          ${{ matrix.cross_compile }}-strip ${{ env.OUTPUT_BINARY }}-${{ matrix.arch }}
          
          echo "✓ Build complete!"
          
          echo "Binary information:"
          file ${{ env.OUTPUT_BINARY }}-${{ matrix.arch }}
          ls -lh ${{ env.OUTPUT_BINARY }}-${{ matrix.arch }}
          
          echo "Checking for dynamic dependencies (should be none):"
          ${{ matrix.cross_compile }}-readelf -d ${{ env.OUTPUT_BINARY }}-${{ matrix.arch }} | grep NEEDED || echo "✓ No dynamic dependencies - fully static!"
      
      - name: Test binary architecture
        run: |
          echo "ELF Header Information:"
          ${{ matrix.cross_compile }}-readelf -h ${{ env.OUTPUT_BINARY }}-${{ matrix.arch }} | grep -E "Class|Machine|Type|Entry"
      
      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.OUTPUT_BINARY }}-${{ matrix.arch }}
          path: ${{ env.OUTPUT_BINARY }}-${{ matrix.arch }}
          retention-days: 30
          
  create-release:
    needs: build-static-arm
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts/ -type f -name "${{ env.OUTPUT_BINARY }}-*" -exec ls -lh {} \;
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: Release Build #${{ github.run_number }}
          body: |
            ## OCU Service Binary - Static ARM Build
            
            ### Available Binary:
            - `ocu_service-armv7` - For ARMv7 devices (32-bit)
            
            ### Usage:
            ```bash
            chmod +x ocu_service-armv7
            ./ocu_service-armv7 server [tcp_port] [grpc_server:port]
            ```
            
            ### Features:
            - Fully static binary (no external dependencies required)
            - Includes all application logic (main, sender, ticket manager, etc.)
            - Built with gRPC ${{ env.GRPC_VERSION }}
          draft: false
          prerelease: false
          files: |
            artifacts/${{ env.OUTPUT_BINARY }}-armv7/${{ env.OUTPUT_BINARY }}-armv7
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}